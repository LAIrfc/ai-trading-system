# 基本面数据与分析总结

## 一、已实现的基本面数据

### 1. 日频估值指标（`get_daily_basic`）

**数据来源**：tushare `daily_basic` 接口

**已获取的字段**：

| 字段 | 说明 | 用途 |
|------|------|------|
| **pe_ttm** | 滚动市盈率（TTM） | ✅ **已用于策略** - PE估值策略的核心指标 |
| **pb** | 市净率 | ⚠️ 已获取但未使用（可用于PB策略） |
| **ps** | 市销率 | ⚠️ 已获取但未使用 |
| **market_cap** | 总市值 | 📊 参考指标 |
| **circ_market_cap** | 流通市值 | 📊 参考指标 |
| **turnover_rate** | 换手率 | 📊 参考指标 |

**数据特点**：
- 频率：日频（每天更新）
- 对齐方式：前向填充（ffill），使用最新已知数据
- 避免未来函数：只使用已发布的数据

### 2. 财务指标（`get_financial_indicators`）

**状态**：⚠️ **未实现**（待扩展）

**计划获取的字段**：

| 字段 | 说明 | 频率 | 用途 |
|------|------|------|------|
| **ROE** | 净资产收益率 | 季频 | 盈利改善策略 |
| **净利润增长率** | 净利润同比/环比增长 | 季频 | 盈利改善策略 |
| **营收增长率** | 营业收入增长 | 季频 | 成长性分析 |
| **资产负债率** | 总负债/总资产 | 季频 | 财务健康策略 |
| **流动比率** | 流动资产/流动负债 | 季频 | 财务健康策略 |

**实现思路**（tushare）：
- `pro.fina_indicator()` - 财务指标
- `pro.balancesheet()` - 资产负债表
- `pro.income()` - 利润表
- 对齐到日频：使用财报**发布日期**（ann_date），而非截止日期（end_date）
- 前向填充：直到下一期财报发布

## 二、已实现的基本面分析

### 1. PE估值策略（`PEStrategy`）✅

**策略文件**：`src/strategies/fundamental_pe.py`

**分析逻辑**：

```
1. 计算PE历史分位数
   - 默认：使用全部历史数据
   - 可选：滚动窗口（如5年=1260天），避免早期数据影响

2. 信号生成
   - PE < 历史20%分位 → BUY（估值低估）
   - PE > 历史80%分位 → SELL（估值高估）
   - 其他 → HOLD（中性）

3. 动态调整
   - 分位数越极端（接近0或1）→ 置信度越高
   - 仓位随信号强度动态调整
   - BUY: [0.65, 0.85]
   - SELL: [0.0, 0.15]（平滑卖出）
```

**关键特性**：
- ✅ **实盘标准**：滚动窗口固定3年（756天），覆盖1个完整牛熊周期，避免参数过拟合
- ✅ 动态置信度和仓位
- ✅ 避免未来函数（只使用已发布数据）
- ✅ **异常值过滤**：自动过滤PE<0或PE>100的异常值
- ✅ 已集成到组合策略（权重1.0）
- ⚠️ **待实现**：分行业计算分位数（实盘底线，需要行业分类数据）

**参数**：
- `low_quantile`: 买入阈值（默认0.2）
- `high_quantile`: 卖出阈值（默认0.8）
- `rolling_window`: 滚动窗口天数（默认756=3年，实盘标准）

**示例信号**：
```
PE低估(分位5.9%，当前PE=5.0) → BUY, conf=0.78, pos=0.79
PE高估(分位94.8%，当前PE=49.1) → SELL, conf=0.78, pos=0.04
PE中性(分位50.3%，当前PE=15.5) → HOLD, conf=0.50, pos=0.50
```

## 三、未实现但计划中的分析

### 1. ROE盈利改善策略 ⏳

**逻辑**：
- 连续两季ROE上升 → BUY（盈利改善）
- ROE连续下降 → SELL（盈利恶化）
- 动态置信度：ROE提升幅度越大，信号越强

**数据需求**：
- ROE（季频）
- 需要对齐到日频（使用财报发布日期）

### 2. PB估值策略 ✅

**策略文件**：`src/strategies/fundamental_pb.py`

**分析逻辑**：
- 类似PE策略，基于PB历史分位数
- PB < 历史20%分位 → BUY（估值低估）
- PB > 历史80%分位 → SELL（估值高估）
- 其他情况 → HOLD（中性）

**关键特性**：
- ✅ **实盘标准**：滚动窗口固定3年（756天），覆盖1个完整牛熊周期，避免参数过拟合
- ✅ 动态置信度和仓位
- ✅ 避免未来函数（只使用已发布数据）
- ✅ **异常值过滤**：自动过滤PB<0或PB>20的异常值
- ✅ **ROE过滤框架**：低PB必须搭配连续3年ROE>8%（待ROE数据获取后启用）
- ✅ 支持分行业计算分位数

**参数**：
- `low_quantile`: 买入阈值（默认0.2）
- `high_quantile`: 卖出阈值（默认0.8）
- `rolling_window`: 滚动窗口天数（默认756=3年，实盘标准）
- `industry`: 行业名称（可选）
- `industry_pb_data`: 行业PB数据序列（可选）
- `min_roe`: 最低ROE要求（默认8%，用于过滤价值陷阱）

### 3. PE+PB双因子策略 ✅

**策略文件**：`src/strategies/fundamental_pe_pb.py`

**分析逻辑**（实盘标准：双因子共振）：
- 买入：PE<20%分位 **AND** PB<20%分位（低估时"与"逻辑，提高确定性）
- 卖出：PE>80%分位 **OR** PB>80%分位（高估时"或"逻辑，快速止损）
- 其他情况 → HOLD（中性）

**关键特性**：
- ✅ 同时考虑PE和PB两个估值指标
- ✅ 低估时要求两个因子都低估（提高确定性）
- ✅ 高估时只要一个因子高估就卖出（快速止损）
- ✅ 两个因子都极端时，信号更强
- ✅ 支持分行业计算分位数
- ✅ 集成PB策略的ROE过滤

**参数**：
- `low_quantile`: 买入阈值（默认0.2）
- `high_quantile`: 卖出阈值（默认0.8）
- `rolling_window`: 滚动窗口天数（默认756=3年）
- `industry`: 行业名称（可选）
- `industry_pe_data`: 行业PE数据序列（可选）
- `industry_pb_data`: 行业PB数据序列（可选）
- `min_roe`: 最低ROE要求（默认8%，用于PB策略过滤价值陷阱）

### 3. 财务健康策略 ⏳

**逻辑**：
- 资产负债率 > 70% → SELL（财务风险）
- 流动比率 < 1.0 → SELL（流动性风险）
- 多个财务指标综合打分

**数据需求**：
- 资产负债表数据（季频）

### 4. 多因子综合打分 ⏳

**逻辑**：
- 综合PE、PB、ROE、净利润增长率等多个因子
- 等权或加权合成打分
- 分数高 → BUY，分数低 → SELL

## 四、数据获取流程

### 当前流程（模拟数据）

```python
# 1. 获取日线数据
daily_df = fetch_sina('600000', 800)

# 2. 生成模拟基本面数据（仅用于测试）
fund_df = create_mock_fundamental_data(daily_df)

# 3. 合并到日线
fetcher = FundamentalFetcher()
merged_df = fetcher.merge_to_daily(daily_df, fund_df, fill_method='ffill')
```

### 真实数据流程（tushare）

```python
# 1. 配置token
import tushare as ts
ts.set_token('your_token')  # 或环境变量 TUSHARE_TOKEN

# 2. 获取日频基本面数据
fetcher = FundamentalFetcher(source='tushare')
fund_df = fetcher.get_daily_basic(
    code='600000',
    start_date='20200101',
    end_date='20231231'
)
# 返回: date, pe_ttm, pb, ps, market_cap, circ_market_cap, turnover_rate

# 3. 合并到日线
merged_df = fetcher.merge_to_daily(daily_df, fund_df, fill_method='ffill')
```

## 五、数据对齐机制

### 为什么需要对齐？

- **基本面数据频率**：季频（财报）或日频（估值指标）
- **策略需要**：日频（每天都要决策）
- **解决方案**：前向填充（ffill）

### 对齐示例

```
财报发布日期     ROE    对齐到日频
2024-01-15     10.5%   → 2024-01-15 ~ 2024-04-14 都用 10.5%
2024-04-15     12.0%   → 2024-04-15 ~ 2024-07-14 都用 12.0%
2024-07-15     11.8%   → 2024-07-15 ~ 2024-10-14 都用 11.8%
```

**关键**：使用财报**发布日期**（ann_date），而非财报截止日期（end_date），避免未来函数。

## 六、当前使用情况

### 在组合策略中

```python
ensemble = EnsembleStrategy()
# 子策略：['MA', 'MACD', 'RSI', 'BOLL', 'KDJ', 'DUAL', 'PE']
# PE策略权重：1.0（中等）
# 注意：PB策略和PE+PB双因子策略需要手动添加到组合策略中
```

### 在回测中

```python
# batch_backtest.py 默认启用基本面数据
# 优先尝试真实数据（tushare），失败则使用模拟数据
```

## 七、总结

### 已实现 ✅

1. **数据获取**：
   - ✅ PE、PB、PS、市值、换手率（日频）
   - ✅ 数据对齐机制（ffill）
   - ✅ 向后兼容（旧导入路径可用）

2. **策略分析**：
   - ✅ PE估值策略（基于历史分位数）
   - ✅ PB估值策略（基于历史分位数）
   - ✅ PE+PB双因子策略（双因子共振）
   - ✅ 支持滚动窗口
   - ✅ 动态置信度和仓位
   - ✅ 分行业计算分位数（基础框架）
   - ✅ ROE过滤框架（待ROE数据获取后启用）

### 待扩展 ⏳

1. **数据获取**：
   - ⏳ ROE、净利润增长率（季频财务指标）
   - ⏳ 资产负债表数据

2. **策略分析**：
   - ⏳ ROE盈利改善策略
   - ⏳ 财务健康策略
   - ⏳ 多因子综合打分

### 数据源

- **tushare**：✅ 已实现（需要token）
- **akshare**：⚠️ 接口不稳定（返回空）

## 八、使用建议

1. **真实回测**：使用 tushare 真实数据，配置 token
2. **测试流程**：可使用模拟数据，但需明确标注
3. **扩展策略**：参考 `fundamental_pe.py` 的实现模式
4. **数据对齐**：确保使用财报发布日期，避免未来函数
