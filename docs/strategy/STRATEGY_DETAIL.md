# 📐 AI 交易系统 — 策略体系详解

> 版本: v2.0 | 更新日期: 2026-02-26
>
> 本文档详细描述系统中所有交易策略的实现原理、参数配置、信号规则和回测引擎。

---

## 目录

- [一、架构总览](#一架构总览)
- [二、统一信号格式](#二统一信号格式-strategysignal)
- [三、6大基础策略详解](#三6大基础策略详解)
  - [① MA 均线交叉](#-ma-均线交叉-ma_crosspy)
  - [② MACD 金叉死叉](#-macd-金叉死叉-macd_crosspy-)
  - [③ RSI 超买超卖](#-rsi-超买超卖-rsi_signalpy)
  - [④ 布林带](#-布林带-bollinger_bandpy)
  - [⑤ KDJ 随机指标](#-kdj-随机指标-kdj_signalpy)
  - [⑥ 双核动量](#-双核动量-dual_momentumpy)
- [四、3大组合策略](#四3大组合策略-ensemblepy)
- [五、回测引擎](#五回测引擎-basepy-backtest-方法)
- [六、关键设计总结](#六关键设计总结)

---

## 一、架构总览

```
src/strategies/
├── base.py              ← 基类 + 回测引擎（止损/止盈/仓位管理）
├── ma_cross.py          ← ① MA 均线交叉策略
├── macd_cross.py        ← ② MACD 金叉死叉策略 🏆（短线最优）
├── rsi_signal.py        ← ③ RSI 超买超卖策略
├── bollinger_band.py    ← ④ 布林带策略
├── kdj_signal.py        ← ⑤ KDJ 随机指标策略
├── dual_momentum.py     ← ⑥ 双核动量策略
├── ensemble.py          ← ⑦⑧⑨ 多策略组合投票（保守/均衡/激进）
└── __init__.py          ← 策略注册中心
```

所有策略遵循统一接口：
- 输入：单只股票的 `DataFrame`（含 `date, open, high, low, close, volume, amount`）
- 输出：标准化的 `StrategySignal`

---

## 二、统一信号格式 (`StrategySignal`)

所有策略输出完全相同的数据结构，定义在 `base.py`：

```python
@dataclass
class StrategySignal:
    action: str           # BUY / SELL / HOLD
    confidence: float     # 0.0 ~ 1.0  信号强度
    reason: str           # 人类可读的决策理由
    position: float       # 0.0 ~ 1.0  建议目标仓位（0=空仓，1=满仓）
    indicators: dict      # 指标快照（如 {'RSI': 28.5, 'MA5': 10.32}）
```

### 字段含义

| 字段 | 含义 | 范围 |
|:-----|:-----|:-----|
| `action` | 操作方向 | `BUY` / `SELL` / `HOLD` |
| `confidence` | 信号强度 | 0\~0.4 弱信号 / 0.4\~0.6 中性 / 0.6\~0.8 较强 / 0.8\~1.0 强 |
| `position` | 建议仓位 | 0.0 = 空仓 → 0.5 = 半仓 → 1.0 = 满仓 |
| `reason` | 决策理由 | 中文可读，如 "金叉: MA5 上穿 MA20" |
| `indicators` | 指标快照 | 策略计算的关键指标值 |

> `confidence` 和 `position` 会在 `__post_init__` 中自动限制到 `[0.0, 1.0]` 范围，不会溢出。

---

## 三、6大基础策略详解

### ① MA 均线交叉 (`ma_cross.py`)

| 项目 | 内容 |
|:-----|:-----|
| **核心思想** | 短期均线上穿长期均线 = 趋势转多，下穿 = 趋势转空 |
| **买入** | MA5 从下方上穿 MA20（金叉） → 置信 0.72，仓位 0.8 |
| **卖出** | MA5 从上方下穿 MA20（死叉） → 置信 0.72，仓位 0.0 |
| **持有** | 多头排列（MA5 > MA20）→ 仓位 0.6；空头排列 → 仓位 0.3 |
| **参数** | `short_window` [3-20, 默认5]，`long_window` [10-120, 默认20] |
| **最少K线** | `max(short, long) + 3` = 23 条 |

**信号逻辑流程：**
```
当日 MA5 > MA20 且 前日 MA5 ≤ MA20 → 金叉 BUY
当日 MA5 < MA20 且 前日 MA5 ≥ MA20 → 死叉 SELL
MA5 > MA20（非交叉日）              → 多头持有 HOLD
MA5 < MA20（非交叉日）              → 空头持有 HOLD
```

---

### ② MACD 金叉死叉 (`macd_cross.py`) 🏆

| 项目 | 内容 |
|:-----|:-----|
| **核心思想** | DIF 上穿 DEA = 金叉买入，下穿 = 死叉卖出；零轴上方金叉更强 |
| **强买入** | DIF 上穿 DEA + DIF > 0（零轴上方）→ 置信 0.78，仓位 0.85 |
| **普通买入** | DIF 上穿 DEA（零轴下方）→ 置信 0.62，仓位 0.7 |
| **辅助买入** | 柱状图由负转正 → 置信 0.55，仓位 0.5 |
| **卖出** | DIF 下穿 DEA → 置信 0.72；柱状图转负 → 置信 0.55 |
| **参数** | `fast` [5-20, 默认12]，`slow` [20-60, 默认26]，`signal` [5-15, 默认9] |
| **最少K线** | `max(fast, slow) + signal + 5` = 40 条 |
| **优化结论** | 100 只股票 5 个月短线最优参数: **(12, 30, 9)**，平均收益 +9.4%，夏普 0.62 |

**信号优先级：**
```
1. DIF 上穿 DEA（金叉）
   ├── DIF > 0 → 强势买入 (conf=0.78, pos=0.85)
   └── DIF ≤ 0 → 普通买入 (conf=0.62, pos=0.70)
2. DIF 下穿 DEA（死叉）→ 卖出 (conf=0.72, pos=0.0)
3. 柱状图由负转正 → 辅助买入 (conf=0.55, pos=0.5)
4. 柱状图由正转负 → 辅助卖出 (conf=0.55, pos=0.2)
5. 无交叉信号 → HOLD
```

> MACD 在 100 只股票 5 个月短线交叉验证中表现最优，是当前**推荐的短线策略**。

---

### ③ RSI 超买超卖 (`rsi_signal.py`)

| 项目 | 内容 |
|:-----|:-----|
| **核心思想** | RSI < 30 超卖考虑买入，RSI > 70 超买考虑卖出 |
| **强买入** | RSI 从超卖区回升突破 30 → 置信 0.78，仓位 0.8 |
| **弱买入** | 超卖区内**拐头确认**（连续 2 日 RSI 回升）→ 置信 0.58，仓位 0.4 |
| **超卖未拐头** | → HOLD，等待底部确认（**避免连续触发**） |
| **卖出** | 对称逻辑：超买区回落突破 70 / 超买区拐头确认 |
| **参数** | `period` [6-30, 默认14]，`oversold` [15-35, 默认30]，`overbought` [65-85, 默认70] |
| **关键设计** | 必须"拐头"才给信号，避免在超卖区持续发出买入 |

**拐头确认机制：**
```
超卖区（RSI < 30）:
  ├── RSI[t] > RSI[t-1] > RSI[t-2]  → 连续2日回升，确认拐头 → BUY (0.58)
  └── 否则                            → 未拐头，继续等待     → HOLD

超买区（RSI > 70）:
  ├── RSI[t] < RSI[t-1] < RSI[t-2]  → 连续2日下滑，确认拐头 → SELL (0.58)
  └── 否则                            → 未拐头，强势持有     → HOLD
```

---

### ④ 布林带 (`bollinger_band.py`)

| 项目 | 内容 |
|:-----|:-----|
| **核心思想** | 价格触及上下轨时产生信号，需拐头确认 |
| **强买入** | 价格从下轨下方回升突破下轨 → 置信 0.75，仓位 0.75 |
| **弱买入** | 下轨下方**连续 2 日回升**（拐头）→ 置信 0.55，仓位 0.35 |
| **下轨未拐头** | → HOLD，等待确认（**避免连续触发**） |
| **卖出** | 对称逻辑：价格从上轨回落 / 上轨上方拐头回落 |
| **指标** | %B 值（价格在带中位置）、带宽百分比 |
| **参数** | `period` [10-40, 默认20]，`std_dev` [1.5-3.0, 默认2.0] |

**核心指标计算：**
```
中轨 = MA(period)
上轨 = 中轨 + std_dev × σ
下轨 = 中轨 - std_dev × σ
%B   = (当前价 - 下轨) / (上轨 - 下轨)    // 0=下轨, 0.5=中轨, 1=上轨
带宽 = (上轨 - 下轨) / 中轨 × 100%
```

**信号逻辑：**
```
价格在下轨下方:
  ├── 前日≤下轨 且 今日>下轨           → 突破回升 BUY (0.75)
  ├── 连续2日回升(Close[t]>Close[t-1]>Close[t-2]) → 拐头 BUY (0.55)
  └── 否则                              → 未拐头 HOLD

价格在上轨上方:
  ├── 前日≥上轨 且 今日<上轨           → 回落突破 SELL (0.75)
  ├── 连续2日回落                       → 拐头 SELL (0.55)
  └── 否则                              → 强势持有 HOLD
```

---

### ⑤ KDJ 随机指标 (`kdj_signal.py`)

| 项目 | 内容 |
|:-----|:-----|
| **核心思想** | K 线与 D 线交叉 + 位置过滤 + J 值拐头确认 |
| **强买入** | K < 30 低位金叉 → 置信 0.80，仓位 0.85 |
| **有效买入** | 30 ≤ K < 50 中低位金叉 → 置信 0.62，仓位 0.6 |
| **K ≥ 50 金叉** | → HOLD（位置偏高，信号偏弱） |
| **J 值超卖买入** | J < 0 且 J 拐头回升 → 置信 0.58，仓位 0.45 |
| **卖出** | 高位死叉 (K > 70) → 0.80；中位死叉 (K > 50) → 0.62；J 值超买拐头 → 0.58 |
| **参数** | `n` [5-21, 默认9]，`m1` [2-5, 默认3]，`m2` [2-5, 默认3] |
| **关键设计** | K 值位置过滤 + J 值拐头确认，避免高位追涨 |

**指标计算：**
```
RSV = (Close - Lowest(n)) / (Highest(n) - Lowest(n)) × 100
K   = EMA(RSV, m1)
D   = EMA(K, m2)
J   = 3K - 2D
```

**金叉信号分级（K 值过滤）：**
```
K上穿D（金叉）:
  ├── K < 30   → 低位金叉 🟢 强买入 (conf=0.80, pos=0.85)
  ├── K < 50   → 中低位金叉 🟢 有效买入 (conf=0.62, pos=0.60)
  └── K ≥ 50   → 高位金叉 ⚪ 观望 (信号偏弱)

K下穿D（死叉）:
  ├── K > 70   → 高位死叉 🔴 强卖出 (conf=0.80, pos=0.00)
  ├── K > 50   → 中高位死叉 🔴 有效卖出 (conf=0.62, pos=0.15)
  └── K ≤ 50   → 低位死叉 ⚪ 观望 (位置偏低)
```

---

### ⑥ 双核动量 (`dual_momentum.py`)

| 项目 | 内容 |
|:-----|:-----|
| **核心思想** | 绝对动量（均线过滤趋势）+ 相对动量（涨幅衡量强度） |
| **买入** | 价格 > MA60（趋势向上）**且** M 日动量 > 0 → 双重确认 |
| **卖出** | 价格 < MA60（趋势向下）**且** 动量 < 0 → 双重预警 |
| **矛盾信号** | 均线下方 + 动量转正 / 均线上方 + 动量转负 → HOLD |
| **置信度** | sigmoid 映射：`conf = 0.55 + 0.30 × tanh(|m|/10)`，范围 [0.55, 0.85] |
| **仓位** | 动量越大仓位越高：`min(0.9, 0.4 + |m|/50)` |
| **参数** | `abs_period` [20-200, 默认60]，`rel_period` [5-120, 默认20] |

**双重信号矩阵：**

| | 动量 > 0 | 动量 < 0 |
|:---|:---------|:---------|
| **价格 > MA60** | 🟢 **BUY** — 双重确认 | ⚪ HOLD — 趋势减弱，关注回调 |
| **价格 < MA60** | ⚪ HOLD — 信号矛盾，等待确认 | 🔴 **SELL** — 双重预警 |

**Sigmoid 置信度映射：**
```
conf = 0.55 + (0.85 - 0.55) × tanh(|momentum| / 10)

动量 ±5%   → conf ≈ 0.62
动量 ±10%  → conf ≈ 0.68
动量 ±20%  → conf ≈ 0.76
动量 ±50%  → conf ≈ 0.83
```

> 使用 sigmoid 风格映射代替线性计算，确保 confidence 始终在 [0.55, 0.85] 范围内，不会溢出。

---

## 四、3大组合策略 (`ensemble.py`)

所有组合策略同时运行上述 6 个基础策略，然后投票决策。

### 预设模式

| 组合 | 模式 | 买入阈值 | 卖出阈值 | 特点 |
|:-----|:-----|:--------|:--------|:-----|
| **保守组合** | majority | ≥ 50% (3/6) | ≥ 34% (2/6) | 买入要多数同意，卖出门槛低（保护优先） |
| **均衡组合** | majority | ≥ 50% (3/6) | ≥ 50% (3/6) | 买卖对称，过半即行动 |
| **激进组合** | weighted | ≥ 35% | ≥ 35% | 加权投票，HOLD 不计分，反应最灵敏 |

### 策略权重

权重基于交叉验证结果，夏普高 + 回撤低 → 权重大：

| 策略 | 权重 | 依据 |
|:-----|:-----|:-----|
| DUAL | 1.5 | 收益最高 |
| BOLL | 1.3 | 夏普最高、回撤最低 |
| MA | 1.2 | 收益第二 |
| MACD | 1.1 | 均衡 |
| RSI | 1.0 | 胜率高 |
| KDJ | 0.9 | 交易频繁 |

### 投票模式详解

#### `majority`（多数投票）
```
买入票 / 总票 ≥ buy_threshold  → BUY
卖出票 / 总票 ≥ sell_threshold → SELL
否则                           → HOLD
```

#### `unanimous`（全票通过）
```
全部 BUY  → BUY
全部 SELL → SELL
否则      → HOLD
```

#### `any`（任意一个，卖出优先）
```
任何一个策略 SELL → SELL（保护利润）
任何一个策略 BUY  → BUY
全部 HOLD         → HOLD
```

#### `weighted`（加权投票）
```
buy_score  = Σ(权重 × confidence)   仅 BUY 票
sell_score = Σ(权重 × confidence)   仅 SELL 票
total_active = buy_score + sell_score

buy_score / total_active ≥ buy_threshold  → BUY
sell_score / total_active ≥ sell_threshold → SELL
否则                                       → HOLD
```

### 关键设计

- **HOLD 不参与计分** — 只有 BUY/SELL 的加权和决定方向，HOLD 只影响"有效策略数"的分母
- **目标仓位** = 所有子策略 position 的加权平均
- **异常保护** — 子策略分析出错时记录日志（`logger.warning`），不影响其他策略

---

## 五、回测引擎 (`base.py` `backtest` 方法)

### 方法签名

```python
def backtest(self, df,
             initial_cash=100000.0,    # 初始资金
             commission=0.0002,        # 手续费率（万分之二）
             stop_loss=0.0,            # 硬止损比例（如0.08=亏8%止损）
             trailing_stop=0.0,        # 跟踪止损比例（如0.05=从最高回撤5%止损）
             take_profit=0.0           # 止盈比例（如0.20=盈利20%止盈）
) -> dict
```

### 功能说明

| 功能 | 说明 |
|:-----|:-----|
| 逐日回测 | 从第 `min_bars` 天开始，每天运行策略并模拟交易 |
| 硬止损 | 亏损达到 `stop_loss` 立即无条件平仓 |
| 跟踪止损 | 从持仓期间最高价回撤 `trailing_stop` 则平仓 |
| 止盈 | 盈利达到 `take_profit` 则平仓 |
| 仓位管理 | 根据 `signal.position` 决定投入资金比例 |
| 手续费 | 默认万分之二（买卖各收） |
| 输出指标 | 总收益、年化收益、最大回撤、胜率、夏普比率、交易明细 |

### 执行流程

```
对每一天 (从 min_bars 开始):
│
├── 1. 【风控检查】（持仓时，优先级最高）
│   ├── 硬止损: 亏损 ≥ stop_loss% → 强制平仓
│   ├── 跟踪止损: 从最高价回撤 ≥ trailing_stop% → 强制平仓
│   └── 止盈: 盈利 ≥ take_profit% → 强制平仓
│
├── 2. 【策略信号】（风控未触发时）
│   ├── 运行 analyze(window) 获取信号
│   ├── BUY + 空仓 → 按 signal.position 比例买入
│   └── SELL + 持仓 → 全部卖出
│
└── 3. 记录权益曲线
```

**风控优先级**：止损/止盈 > 策略信号（持仓时先检查风控，再处理策略）

### 输出结果

```python
{
    'trades': [...],              # 交易明细列表
    'final_value': 123456.78,     # 最终总资产
    'total_return': 23.46,        # 总收益率 (%)
    'annualized_return': 18.50,   # 年化收益率 (%)
    'max_drawdown': 12.30,        # 最大回撤 (%)
    'win_rate': 65.0,             # 胜率 (%)
    'trade_count': 8,             # 完成交易次数（卖出次数）
    'sharpe': 1.25,               # 夏普比率（年化）
}
```

---

## 六、关键设计总结

### 1. 拐头确认机制
RSI、布林带、KDJ 在极值区不直接触发信号，必须**连续 2 日反向运动**确认拐头，避免在超卖/超买区频繁开仓。

### 2. 位置过滤
KDJ 金叉必须 **K < 50** 才有效，K ≥ 50 视为高位金叉不买入，避免高位追涨。

### 3. Sigmoid 置信度映射
双核动量使用 `tanh` 映射，确保 confidence 永远不会溢出 [0.55, 0.85] 范围。

### 4. 统一 `param_ranges`
每个策略定义参数范围 `(min, default, max, step)`，支持自动化参数扫描优化。

```python
param_ranges = {
    'fast_period': (5, 12, 20, 1),     # (最小值, 默认值, 最大值, 步长)
    'slow_period': (20, 26, 60, 2),
}
```

### 5. 异常保护
`safe_analyze()` 封装确保：
- 数据不足时返回 HOLD（不崩溃）
- 计算异常时返回 HOLD + 日志记录
- **系统永远不会 crash**

### 6. 风控优先
回测引擎中，风控检查（止损/止盈）**优先级高于策略信号**，确保极端行情下的资金安全。

---

## 附录：参数速查表

| 策略 | 参数 | 默认值 | 范围 | 步长 |
|:-----|:-----|:-------|:-----|:-----|
| MA | `short_window` | 5 | 3 ~ 20 | 1 |
| MA | `long_window` | 20 | 10 ~ 120 | 5 |
| MACD | `fast_period` | 12 | 5 ~ 20 | 1 |
| MACD | `slow_period` | 26 | 20 ~ 60 | 2 |
| MACD | `signal_period` | 9 | 5 ~ 15 | 1 |
| RSI | `period` | 14 | 6 ~ 30 | 1 |
| RSI | `oversold` | 30 | 15 ~ 35 | 5 |
| RSI | `overbought` | 70 | 65 ~ 85 | 5 |
| BOLL | `period` | 20 | 10 ~ 40 | 2 |
| BOLL | `std_dev` | 2.0 | 1.5 ~ 3.0 | 0.25 |
| KDJ | `n` | 9 | 5 ~ 21 | 1 |
| KDJ | `m1` | 3 | 2 ~ 5 | 1 |
| KDJ | `m2` | 3 | 2 ~ 5 | 1 |
| DUAL | `abs_period` | 60 | 20 ~ 200 | 10 |
| DUAL | `rel_period` | 20 | 5 ~ 120 | 5 |
| 组合 | `buy_threshold` | 0.5 | 0.3 ~ 0.8 | 0.05 |
| 组合 | `sell_threshold` | 0.5 | 0.3 ~ 0.8 | 0.05 |
