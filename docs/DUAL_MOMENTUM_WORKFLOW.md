# 双核动量轮动策略 — 完整工作流文档

> 版本: v1.0 | 更新日期: 2026-02-24

---

## 目录

- [一、策略定义](#一策略定义)
- [二、整体架构](#二整体架构)
- [三、第一阶段：数据准备](#三第一阶段数据准备)
- [四、第二阶段：策略计算](#四第二阶段策略计算)
- [五、第三阶段：交易执行](#五第三阶段交易执行)
- [六、第四阶段：回测与评估](#六第四阶段回测与评估)
- [七、第五阶段：参数优化](#七第五阶段参数优化)
- [八、第六阶段：实盘部署](#八第六阶段实盘部署)
- [九、文件对应关系](#九文件对应关系)
- [十、日常使用命令速查](#十日常使用命令速查)
- [十一、核心理念](#十一核心理念)

---

## 一、策略定义

> 以下为策略完整规范，是整个系统的"宪法"。所有代码实现必须严格遵照本章定义。

### 1.1 基本信息

| 字段 | 内容 |
|------|------|
| **策略名称** | 双核动量轮动策略 (Dual Momentum Rotational Strategy) |
| **版本** | v1.0 |
| **创建日期** | 2026-02-24 |
| **策略类型** | 中频趋势跟踪 / 资产配置 |
| **时间框架** | 日线 |
| **适合标的** | A股主流ETF |
| **风险等级** | 中等 |
| **建议资金规模** | 10万 - 500万 |

### 1.2 核心思想

> **不预测未来，只应对当下。**
>
> 我们认为资产的趋势一旦形成，会具有一定的惯性。我们不关心资产为什么涨，只关心它是否在涨，以及是否比别的资产涨得更好。

在股票、债券、商品等不同大类资产之间轮动，**永远持有最强趋势的资产**。

### 1.3 策略构成

本策略由两个核心模块构成：

```
┌────────────────────────────────────────────────────────┐
│                   双核动量                               │
│                                                        │
│   ┌──────────────────┐    ┌──────────────────┐         │
│   │  绝对动量（过滤器）│    │  相对动量（选择器）│         │
│   │                  │    │                  │         │
│   │  回答：能不能买？  │ →  │  回答：买哪个？   │ → 信号  │
│   │                  │    │                  │         │
│   │  当前价格 >       │    │  过去60日涨幅     │         │
│   │  200日均线？      │    │  最大的是谁？     │         │
│   └──────────────────┘    └──────────────────┘         │
└────────────────────────────────────────────────────────┘
```

#### 绝对动量（过滤器）— 熊市保护机制

- **作用**：判断当前市场是否适合参与。只有当资产自身的趋势是向上的，我们才考虑买入
- **条件**：当前价格 > N日均线（默认 N=200）
- **效果**：在市场整体下跌时自动空仓，避免巨大回撤

#### 相对动量（选择器）— 优胜劣汰机制

- **作用**：在所有通过"绝对动量"测试的资产中，选出最强的那一个（或前K个）进行持有
- **方法**：计算过去M日（默认 M=60）的涨幅，选择涨幅最大的资产
- **效果**：确保我们始终骑在最快的马背上

### 1.4 观察池定义

选定 5 个相关性较低的大类资产 ETF 构成观察池：

| 代码 | 名称 | 资产类别 | 角色 |
|------|------|---------|------|
| **510300** | 沪深300ETF | 国内大盘股 | 核心配置 |
| **159949** | 创业板50ETF | 国内成长股 | 进攻端 |
| **513100** | 纳指ETF | 海外科技股 | 全球配置 |
| **518880** | 黄金ETF | 商品 | 避险对冲 |
| **511520** | 国债ETF | 债券 | 防守端 / 空仓替代 |

> 观察池的设计原则：覆盖多个大类资产，彼此相关性低，确保在任何市场环境下至少有一个资产处于上升趋势。

### 1.5 具体交易规则

#### 第一步：绝对动量过滤

```
对于观察池中的每一个资产 i：
    如果 当前价格(i) > MA_N(i)     → 通过 → 进入"备选池"
    如果 当前价格(i) ≤ MA_N(i)     → 排除
    
如果 备选池为空：
    → 卖出所有持仓
    → 持有现金（或国债ETF 511520 作为避风港）
```

#### 第二步：流动性过滤

```
对于备选池中的每一个资产 i：
    如果 日均成交额(i) < 5000万元  → 排除
```

#### 第三步：相对动量排序

```
对于备选池中的每一个资产 i：
    动量得分(i) = 当前价格(i) / M日前价格(i) - 1

将备选池按动量得分从高到低排序
```

#### 第四步：生成交易信号

```
选择排名前 K 个资产（默认 K=1）

如果 新的第1名 ≠ 当前持仓：
    → 卖出当前持仓（轮出）
    → 买入新的第1名（轮入）
    
如果 新的第1名 = 当前持仓：
    → 继续持有，不操作

如果 备选池为空：
    → 全部清仓 → 持有现金
```

#### 调仓时间

- **频率**：每 F 个交易日执行一次（默认 F=20，约月度）
- **时点**：每月最后一个交易日，收盘前 30 分钟计算信号，收盘前 15 分钟执行交易

### 1.6 策略参数

| 参数名 | 符号 | 默认值 | 说明 | 调优范围 |
|--------|------|--------|------|---------|
| 绝对动量周期 | N | **200** | 判断牛熊的长期均线天数。越长信号越稳，但反应越慢 | 150 / 200 / 250 |
| 相对动量周期 | M | **60** | 计算涨幅的回看天数。越短对热点反应越快，但交易越频繁 | 20 / 60 / 120 |
| 调仓频率 | F | **20 交易日** | 多久重新计算一次。越频繁越跟趋势，但摩擦成本越高 | 5 / 10 / 20 |
| 持有数量 | K | **1** | 同时持有前几名。K=1 集中最强，K>1 分散风险 | 1 / 2 / 3 |

### 1.7 风险控制条款

> ⚠️ **这是策略中最重要的部分。任何情况下，风控规则优先级高于收益追求。**

#### 条款一：硬性止损

```
如果 任一持仓资产亏损 ≥ 10%（从买入价计算）：
    → 立即无条件清仓该资产
    → 该资产加入当月黑名单，当月不再买入
```

#### 条款二：黑天鹅保护

```
如果 单日大盘指数（上证指数）跌幅 > 5%：
    → 触发熔断机制
    → 立即清仓所有持仓
    → 进入 24 小时观察期
    → 观察期结束后方可重新开仓
```

#### 条款三：流动性过滤

```
只交易日均成交额 > 5000万元 的 ETF
目的：避免滑点过大导致实际成本远超预期
```

#### 条款四：最大持仓限制

```
单一 ETF 持仓仓位 ≤ 总资金的 30%
（当 K=1 时，该条自动满仓，可根据实际情况调整）
```

### 1.8 交易执行规则

| 步骤 | 时间 | 动作 |
|------|------|------|
| 1 | 收盘前 30 分钟 | 运行策略脚本，计算所有信号 |
| 2 | 收盘前 20 分钟 | 生成交易指令清单，人工复核 |
| 3 | 收盘前 15 分钟 | 执行交易（手动 / 自动化） |
| 4 | 收盘后 | 记录交易日志和审计信息 |

#### 异常处理

| 异常场景 | 处理规则 |
|---------|---------|
| 交易失败 | 记录失败原因，下一交易日重试 |
| 标的停牌 | 跳过该标的，选择排名次之的 |
| 流动性不足 | 降低交易量或推迟至次日 |
| 数据获取失败 | 使用上一交易日数据，推迟调仓 1 天 |

### 1.9 回测基础设置

| 设置项 | 值 |
|--------|-----|
| 初始资金 | 1,000,000 元 |
| 手续费 | 万分之 2（买入 + 卖出） |
| 滑点 | 0.2% |
| 回测周期 | 2020-01-01 至今 |

#### 评估指标

- 年化收益率
- 最大回撤
- 夏普比率
- 卡玛比率（年化收益 / 最大回撤）
- 月度胜率
- 换手率
- 持仓天数分布

### 1.10 待优化方向

| # | 方向 | 说明 |
|---|------|------|
| 1 | 动态参数调整 | 根据市场波动率动态调整 N 和 M |
| 2 | 多因子融合 | 除动量外，引入波动率、成交量等辅助因子 |
| 3 | 市场环境识别 | 识别牛市、熊市、震荡市，采用不同参数 |
| 4 | 交易成本优化 | 减少不必要的调仓，降低摩擦成本 |
| 5 | 风险平价 | 根据资产波动率动态分配仓位权重 |

### 1.11 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| v1.0 | 2026-02-24 | 初始版本，定义核心策略逻辑 | System |

---

## 二、整体架构

```
┌──────────────────────────────────────────────────────────────┐
│                     双核动量轮动策略                           │
├───────────────┬────────────────┬─────────────────────────────┤
│    数据层      │     策略层      │        执行层                │
│               │                │                             │
│  ETF历史数据   │  绝对动量计算    │  回测引擎（验证策略有效性）    │
│  (baostock /  │  相对动量排序    │  模拟交易（无风险测试）       │
│   模拟数据)    │  风控规则检查    │  同花顺桌面（实盘交易）       │
│       ↓       │  交易信号生成    │                             │
│  MultiIndex   │       ↓        │                             │
│  DataFrame    │  买入/卖出/持有  │                             │
└───────────────┴────────────────┴─────────────────────────────┘
```

### 三层设计理念

| 层级 | 职责 | 可替换性 |
|------|------|---------|
| **数据层** | 获取、清洗、缓存市场数据 | 数据源可自由切换（baostock / akshare / 东方财富） |
| **策略层** | 纯数学计算，不涉及具体交易 | 策略可独立测试，参数可调 |
| **执行层** | 将策略信号转化为实际交易动作 | 回测 / 模拟 / 实盘三种模式无缝切换 |

---

## 三、第一阶段：数据准备

### 3.1 数据获取流程

```
    ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ baostock │ or  │ 东方财富   │ or  │ 模拟数据   │
    │ (免费API) │     │ (HTTP)   │     │ (离线测试) │
    └────┬─────┘     └────┬─────┘     └────┬─────┘
         │                │                │
         └───────┬────────┘────────────────┘
                 ▼
    ┌────────────────────────────────┐
    │      ETFDataFetcher            │
    │                                │
    │  - 自动尝试多个数据源           │
    │  - 数据不足时自动降级为模拟数据  │
    │  - 统一输出 MultiIndex 格式     │
    └────────────┬───────────────────┘
                 ▼
    ┌────────────────────────────────┐
    │    MultiIndex DataFrame        │
    │                                │
    │    Level 0: ETF代码             │
    │    Level 1: OHLCV 字段          │
    │    Rows:    交易日（约822行）    │
    └────────────────────────────────┘
```

### 3.2 ETF 观察池

| 代码 | 名称 | 代表资产类别 | 选入理由 |
|------|------|-------------|---------|
| 510300 | 沪深300ETF | 国内大盘股 | A股核心资产代表 |
| 159949 | 创业板50ETF | 国内成长股 | 高弹性成长板块 |
| 513100 | 纳指ETF | 海外科技股 | 全球科技趋势捕获 |
| 518880 | 黄金ETF | 商品 | 避险资产、与股市低相关 |
| 511520 | 国债ETF | 债券 | 安全港，熊市避风 |

### 3.3 数据格式示例

```
              510300                    159949             ...
              open   high   low  close  volume  open  ...
2020-01-02   3.857  3.880  3.840  3.871  1.2e8  0.812 ...
2020-01-03   3.875  3.892  3.860  3.885  1.1e8  0.818 ...
...
```

### 3.4 涉及文件

| 文件 | 作用 |
|------|------|
| `src/data/etf_data_fetcher.py` | ETF 数据获取核心模块 |

### 3.5 数据降级策略

```
尝试 baostock → 成功 → 使用真实数据
        ↓ 失败
尝试 东方财富 HTTP → 成功 → 使用真实数据
        ↓ 失败
检查数据量是否 >= 200 行
        ↓ 不足
生成模拟数据（基于真实价格区间的随机游走）
```

> ⚠️ 模拟数据仅用于验证策略逻辑是否正确，不可用于评估策略实际收益。

---

## 四、第二阶段：策略计算

### 4.1 计算触发条件

- **定时触发**：每 20 个交易日（约 1 个月）执行一次完整计算
- **实时触发**：每日检查止损和黑天鹅条件

### 4.2 计算流程（每个调仓日执行）

```
┌──────────────────────────────────────────────────────────┐
│ Step 0: 风控前置检查（每日执行）                            │
│                                                          │
│  ① 黑天鹅检测：单日大盘指数跌幅 > 5%？                     │
│     → 是：全部清仓，进入 24 小时观察期                      │
│                                                          │
│  ② 硬性止损：任一持仓亏损 > 10%（从买入价计算）？            │
│     → 是：立即卖出该ETF，加入当月黑名单                     │
└────────────────────────┬─────────────────────────────────┘
                         ▼
┌──────────────────────────────────────────────────────────┐
│ Step 1: 绝对动量过滤 🛡️                                   │
│                                                          │
│  公式：当前价格 > 200日均线？                               │
│                                                          │
│  目的：只买处于上升趋势的资产                               │
│  效果：熊市时自动空仓，避免巨大回撤                         │
│                                                          │
│  示例：                                                   │
│    510300: 当前 3.85 > MA200 3.72 → ✅ 通过               │
│    159949: 当前 0.75 < MA200 0.82 → ❌ 排除（下跌趋势）    │
│    513100: 当前 1.62 > MA200 1.55 → ✅ 通过               │
│    518880: 当前 5.30 > MA200 5.10 → ✅ 通过               │
│    511520: 当前 103.5 > MA200 102.8 → ✅ 通过             │
│                                                          │
│  → 备选池 = [510300, 513100, 518880, 511520]              │
│  → 如果备选池为空，则清仓持有现金                           │
└────────────────────────┬─────────────────────────────────┘
                         ▼
┌──────────────────────────────────────────────────────────┐
│ Step 2: 流动性过滤                                        │
│                                                          │
│  条件：日均成交额 > 5000万                                 │
│  目的：避免买入流动性差的ETF导致滑点过大                     │
│                                                          │
│  → 过滤后的备选池                                         │
└────────────────────────┬─────────────────────────────────┘
                         ▼
┌──────────────────────────────────────────────────────────┐
│ Step 3: 相对动量排序 🏆                                    │
│                                                          │
│  公式：动量得分 = 当前价格 / 60日前价格 - 1                 │
│                                                          │
│  目的：在所有合格资产中选出涨势最强的                       │
│                                                          │
│  示例：                                                   │
│    510300: +3.2%                                         │
│    513100: +8.5%  ← 🥇 最强                              │
│    518880: +5.1%                                         │
│    511520: +0.8%                                         │
│                                                          │
│  → 排名: 513100 > 518880 > 510300 > 511520               │
└────────────────────────┬─────────────────────────────────┘
                         ▼
┌──────────────────────────────────────────────────────────┐
│ Step 4: 生成交易信号                                      │
│                                                          │
│  K=1 → 只持有排名第 1 的资产                               │
│                                                          │
│  场景1：第1名变了 → 轮换                                   │
│    卖出 518880（旧持仓） + 买入 513100（新冠军）            │
│                                                          │
│  场景2：第1名没变 → 继续持有                               │
│    无操作                                                 │
│                                                          │
│  场景3：备选池为空 → 空仓                                  │
│    卖出所有持仓 → 持有现金（或国债ETF）                     │
└──────────────────────────────────────────────────────────┘
```

### 4.3 策略参数一览

| 参数名 | 符号 | 默认值 | 说明 | 调优范围 |
|--------|------|--------|------|---------|
| 绝对动量周期 | N | 200 | 判断牛熊的长期均线天数 | 150 / 200 / 250 |
| 相对动量周期 | M | 60 | 计算涨幅排名的回看天数 | 20 / 60 / 120 |
| 调仓频率 | F | 20 交易日 | 多久重新计算一次 | 5 / 10 / 20 |
| 持有数量 | K | 1 | 同时持有前几名 | 1 / 2 / 3 |
| 硬性止损线 | — | -10% | 单一持仓最大亏损 | -8% / -10% / -15% |
| 黑天鹅阈值 | — | -5% | 大盘单日跌幅触发熔断 | -3% / -5% / -7% |
| 流动性门槛 | — | 5000万 | 日均成交额最低要求 | 3000万 / 5000万 / 1亿 |
| 最大持仓比例 | — | 30% | 单一ETF最大仓位 | 20% / 30% / 50% |

### 4.4 涉及文件

| 文件 | 作用 |
|------|------|
| `src/core/strategy/dual_momentum_strategy.py` | 策略核心计算逻辑 |
| `src/core/strategy/base_strategy.py` | 策略基类 |

---

## 五、第三阶段：交易执行

### 5.1 执行流程

```
    策略信号
       │
       ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   信号解析    │ ──→ │   仓位计算    │ ──→ │   下单执行    │
│              │     │              │     │              │
│ 买入 513100  │     │ 可用资金 / K  │     │ 方式1: 回测  │
│ 卖出 518880  │     │ = 100万 / 1  │     │ 方式2: 模拟  │
│              │     │ = 100万      │     │ 方式3: 实盘  │
│              │     │              │     │              │
│              │     │ 持仓限制检查  │     │ 记录交易日志  │
│              │     │ ≤ 30% 总资金 │     │ 更新持仓状态  │
│              │     │              │     │ 扣除手续费    │
│              │     │ 股数 = 金额  │     │              │
│              │     │ / 价格       │     │              │
│              │     │ / 100 × 100  │     │              │
│              │     │ (取整到手)    │     │              │
└──────────────┘     └──────────────┘     └──────────────┘
```

### 5.2 三种执行模式

| 模式 | 用途 | 风险 | 适用阶段 |
|------|------|------|---------|
| **回测** | 用历史数据验证策略有效性 | 零 | 策略开发 & 参数优化 |
| **模拟交易** | 虚拟账户实时跟踪 | 零 | 上线前最终验证 |
| **实盘交易** | 真实资金执行 | 真实 | 策略验证通过后 |

### 5.3 手续费模型

```
手续费 = 成交金额 × 0.0002 (万分之二)

示例：
  买入 513100，成交金额 100,000 元
  手续费 = 100,000 × 0.0002 = 20 元
```

### 5.4 涉及文件

| 文件 | 作用 |
|------|------|
| `src/api/broker/tonghuashun_desktop.py` | 同花顺桌面自动化（实盘） |
| `src/core/simulator/paper_trading.py` | 模拟交易账户 |
| `backtest_dual_momentum.py` | 回测引擎 |

---

## 六、第四阶段：回测与评估

### 6.1 回测时间线

```
Day 1                     Day 200              Day 201        Day N
  │◄── 历史数据预热期 ──►│              │◄── 策略运行期 ──►│
  │    (计算200日均线)      │              │                  │
  │    不产生交易            │              │  每20天调仓一次    │
  │                         │              │  每天检查止损      │
  │                         │              │  每天记录净值      │
```

### 6.2 每日回测逻辑

```python
for 每个交易日 in 回测区间:
    1. 更新所有ETF的最新价格
    2. 检查是否触发止损 → 触发则立即卖出
    3. 检查是否触发黑天鹅 → 触发则全仓清仓
    4. 是否到达调仓日？
       → 是: 执行完整策略计算 (Step 1-4)
       → 否: 跳过
    5. 记录当日净值 = 现金 + 持仓市值
    6. 计算当日收益率
```

### 6.3 评估指标

| 指标 | 公式 | 含义 |
|------|------|------|
| **总收益率** | (最终资产 - 初始资金) / 初始资金 | 赚了多少 |
| **年化收益率** | (最终资产/初始资金)^(252/交易天数) - 1 | 平均每年赚多少 |
| **最大回撤** | max((峰值 - 谷值) / 峰值) | 最惨的时候亏了多少 |
| **夏普比率** | (年化收益 - 无风险利率) / 年化波动率 | 每承受1单位风险赚多少 |
| **卡尔马比率** | 年化收益率 / 最大回撤 | 收益与最大风险的比值 |
| **日胜率** | 盈利天数 / 总交易天数 | 多少天是赚钱的 |

### 6.4 回测输出

```
回测完成后生成：

1. 控制台报告
   ┌─────────────────────────────────────┐
   │     双核动量轮动策略 - 回测报告       │
   ├─────────────────────────────────────┤
   │ 初始资金:      1,000,000.00 元      │
   │ 最终资产:      1,190,479.00 元      │
   │ 总收益率:             19.05%        │
   │ 年化收益率:            3.31%        │
   │ 最大回撤:            -10.17%        │
   │ 夏普比率:              0.07         │
   │ 总交易次数:              63         │
   │ 总手续费:          4,309 元         │
   └─────────────────────────────────────┘

2. 净值曲线图
   → dual_momentum_backtest_result.png

3. 交易记录
   → dual_momentum_trades.csv

4. 详细日志
   → logs/dual_momentum_backtest.log
```

### 6.5 涉及文件

| 文件 | 作用 |
|------|------|
| `backtest_dual_momentum.py` | 回测主程序 |
| `test_dual_momentum_quick.py` | 快速信号测试 |

---

## 七、第五阶段：参数优化

### 7.1 优化流程

```
┌─────────────────┐
│  选择待优化参数   │
│  (一次只调一个)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  设定参数范围     │ ──→ │  逐一运行回测     │ ──→ │  对比评估指标     │
│                 │     │                 │     │                 │
│  例如:           │     │  N=150 → 回测   │     │  N=150: 收益 12% │
│  N = [150,      │     │  N=200 → 回测   │     │  N=200: 收益 8%  │
│       200,      │     │  N=250 → 回测   │     │  N=250: 收益 5%  │
│       250]      │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
                                                ┌─────────────────┐
                                                │ 选择最优参数      │
                                                │                 │
                                                │ 综合考虑:        │
                                                │ - 收益率         │
                                                │ - 最大回撤       │
                                                │ - 夏普比率       │
                                                │ - 交易频率       │
                                                └─────────────────┘
```

### 7.2 优化任务清单

| 优先级 | 参数 | 测试值 | 关注指标 |
|--------|------|--------|---------|
| 1 | N (绝对动量周期) | 150 / 200 / 250 | 最大回撤 |
| 2 | M (相对动量周期) | 20 / 60 / 120 | 收益率 + 换手率 |
| 3 | F (调仓频率) | 5 / 10 / 20 | 扣费后净收益 |
| 4 | K (持有数量) | 1 / 2 / 3 | 净值曲线平滑度 |

### 7.3 修改参数方法

在 `backtest_dual_momentum.py` 中修改配置字典：

```python
config = {
    'etf_pool': ['510300', '159949', '513100', '518880', '511520'],
    'absolute_period': 200,   # ← 修改 N
    'relative_period': 60,    # ← 修改 M
    'rebalance_days': 20,     # ← 修改 F
    'top_k': 1,               # ← 修改 K
    'stop_loss_pct': -0.10,   # ← 修改止损线
}
```

### 7.4 注意事项

- **避免过拟合**：不要针对特定历史区间反复调参到最优，那只是"看后视镜开车"
- **样本外测试**：用 2020-2023 的数据调参，用 2024-2025 的数据验证
- **交易成本**：参数越激进（周期越短、调仓越频繁），手续费越高
- **稳健性**：好的参数组合应该在多个时间段都表现不错，而非只在某段特别好

---

## 八、第六阶段：实盘部署

### 8.1 部署前检查清单

- [ ] 回测收益率 > 基准（沪深300）
- [ ] 最大回撤 < 可接受范围（建议 < 20%）
- [ ] 夏普比率 > 0.5
- [ ] 模拟交易运行 ≥ 3 个月，结果与回测一致
- [ ] 风控规则全部通过测试
- [ ] 同花顺账户配置完成

### 8.2 每月执行流程

```
月底最后一个交易日 14:00 - 14:30

Step 1: 运行策略计算
┌──────────────────────────────────────────┐
│ $ python3 test_dual_momentum_quick.py    │
│                                          │
│ 输出:                                    │
│   当前持仓: 518880 (黄金ETF)              │
│   信号:                                  │
│     518880 → 卖出 (动量排名下降)           │
│     513100 → 买入 (动量排名第1)            │
└──────────────────────────────────────────┘

Step 2: 确认信号合理性
┌──────────────────────────────────────────┐
│ 人工快速复核:                             │
│   - 信号是否符合策略文档的逻辑？            │
│   - 数据是否异常？                         │
│   - 市场是否有重大突发事件？                │
│                                          │
│ ⚠️ 复核不是推翻信号，而是检查系统是否正常   │
└──────────────────────────────────────────┘

Step 3: 执行交易
┌──────────────────────────────────────────┐
│ 方式A: 手动操作                           │
│   → 打开同花顺，按信号手动买卖              │
│                                          │
│ 方式B: 桌面自动化                         │
│   → python3 examples/tonghuashun_        │
│     simulator.py                         │
│   → 自动控制同花顺执行交易                 │
│                                          │
│ 方式C: 先模拟再实盘                       │
│   → 用同花顺模拟账户先执行                 │
│   → 确认无误后再切换实盘账户               │
└──────────────────────────────────────────┘

Step 4: 记录交易日志
┌──────────────────────────────────────────┐
│ 记录内容:                                │
│   - 交易日期/时间                         │
│   - 买卖方向 & 标的                       │
│   - 成交价格 & 数量                       │
│   - 手续费                               │
│   - 持仓变化                             │
│   - 策略依据（动量得分、排名）             │
│   - 账户总资产                            │
└──────────────────────────────────────────┘
```

### 8.3 异常处理

| 场景 | 处理方式 |
|------|---------|
| 数据获取失败 | 使用上一交易日的数据，推迟调仓 1 天 |
| 同花顺连接中断 | 手动登录后重试，或改为手动下单 |
| 信号与直觉矛盾 | **严格执行信号**，纪律 > 预测 |
| 单日大盘暴跌 > 5% | 触发黑天鹅保护，自动清仓 |
| ETF 停牌 | 跳过该 ETF，选择排名次之的 |

---

## 九、文件对应关系

```
ai-trading-system/
│
├── 📄 策略文档
│   └── strategies/
│       └── dual_momentum_strategy.md       ← 策略的"宪法"，所有规则的源头
│
├── 💻 核心代码
│   └── src/
│       ├── data/
│       │   └── etf_data_fetcher.py         ← 第一阶段：数据获取
│       │
│       └── core/strategy/
│           ├── base_strategy.py            ← 策略基类（接口定义）
│           └── dual_momentum_strategy.py   ← 第二阶段：策略核心计算
│
├── 🧪 回测 & 测试
│   ├── backtest_dual_momentum.py           ← 第四阶段：完整回测
│   └── test_dual_momentum_quick.py         ← 快速信号验证
│
├── 🔌 交易接口
│   └── src/
│       ├── api/broker/
│       │   └── tonghuashun_desktop.py      ← 第六阶段：同花顺桌面自动化
│       │
│       └── core/simulator/
│           └── paper_trading.py            ← 模拟交易账户
│
├── 📊 输出文件
│   ├── dual_momentum_backtest_result.png   ← 净值曲线图
│   ├── dual_momentum_trades.csv            ← 交易记录明细
│   └── logs/
│       └── dual_momentum_backtest.log      ← 详细运行日志
│
└── 📚 文档
    ├── docs/
    │   └── DUAL_MOMENTUM_WORKFLOW.md       ← 本文档（完整工作流）
    ├── DUAL_MOMENTUM_GUIDE.md              ← 使用指南
    └── QUICK_REFERENCE.md                  ← 快速参考卡
```

---

## 十、日常使用命令速查

### 10.1 基础操作

```bash
# 进入项目目录
cd /home/wangxinghan/codetree/ai-trading-system

# 快速查看当前信号（约1分钟）
python3 test_dual_momentum_quick.py

# 运行完整回测（约5分钟）
python3 backtest_dual_momentum.py

# 查看策略文档
cat strategies/dual_momentum_strategy.md

# 查看回测报告图
xdg-open dual_momentum_backtest_result.png    # Linux
start dual_momentum_backtest_result.png       # Windows
```

### 10.2 策略调参

```bash
# 编辑回测脚本中的参数
# 修改 backtest_dual_momentum.py 中的 config 字典
# 然后重新运行：
python3 backtest_dual_momentum.py
```

### 10.3 版本管理

```bash
# 提交改动
git add .
git commit -m "优化参数: N=150, M=60"
git push

# 查看历史
git log --oneline
```

---

## 十一、核心理念

### 11.1 投资哲学

```
不预测未来，只应对当下。

趋势一旦形成，会具有一定的惯性。
我们不关心资产为什么涨，
只关心它是否在涨，
以及是否比别的资产涨得更好。
```

### 11.2 执行纪律

```
策略文档（宪法）
    ↓
严格按文档执行（不加入人为判断）
    ↓
回测验证（用数据说话）
    ↓
参数优化（科学调参，避免过拟合）
    ↓
模拟交易（风险为零的实战演练）
    ↓
小资金实盘（最终验证）
    ↓
逐步放大（信心建立后）
```

### 11.3 铁律

| # | 规则 | 说明 |
|---|------|------|
| 1 | **纪律 > 预测** | 策略说买就买，说卖就卖，不掺杂个人情绪 |
| 2 | **风控 > 收益** | 任何时候，保住本金都比赚钱重要 |
| 3 | **系统 > 直觉** | 信任经过回测验证的系统，而非盘感 |
| 4 | **简单 > 复杂** | 越简单的策略越不容易过拟合，越稳健 |
| 5 | **记录 > 回忆** | 每笔交易都必须有日志，事后复盘靠数据不靠记忆 |

---

> 📌 **本文档应当与策略文档 (`strategies/dual_momentum_strategy.md`) 一同维护，任何策略变更必须先更新文档，再修改代码。**
