# 基本面策略实盘权威标准

## 一、当前设计的实盘合理性

### ✅ 单一因子先验证、再叠加（铁律）

**权威依据**：
- PE（尤其是TTM PE）是全球量化体系中最具普适性的估值因子
- Fama-French三因子模型的估值延伸逻辑已验证PE的均值回归特性
- 实盘归因要求：必须明确"收益来自哪一个因子"
- 若初始就叠加PE+PB，二者高度相关（相关系数通常>0.6），无法拆分因子贡献度

**当前状态**：✅ **完全符合实盘铁律**

---

## 二、各因子的实盘权威实操标准

### 1. PE策略（当前实现）

| 实盘核心要点 | 权威标准 | 当前状态 | 改进方向 |
|------------|---------|---------|---------|
| **分行业计算分位数** | 必须分申万一级行业，不能全市场统一 | ⚠️ **未实现** | 需要行业分类数据 |
| **滚动窗口** | 固定3年（756天），覆盖1个完整牛熊周期 | ⚠️ **可配置** | 默认改为756天 |
| **阈值校准** | PE<20%分位买入，PE>80%分位卖出 | ✅ **已实现** | 保持 |
| **PE范围过滤** | 剔除PE<0或PE>100的异常值 | ⚠️ **未实现** | 添加过滤 |
| **ST/退市过滤** | 剔除ST、退市预警标的 | ⚠️ **未实现** | 在股票池层面过滤 |

**必须规避的坑点**：
- ❌ **全市场因子同质化**：消费股PE 30倍是低估，周期股PE 30倍可能是高估
- ❌ **参数过拟合**：窗口不能为了优化回测收益而调整为1年或半年

### 2. PB策略 ✅

| 实盘核心要点 | 权威标准 | 当前状态 |
|------------|---------|---------|
| **分行业计算分位数** | 必须分申万一级行业 | ✅ **已实现**（复用PE策略的行业分类逻辑） |
| **绑定ROE过滤** | 低PB必须搭配连续3年ROE>8%，否则可能是价值陷阱 | ⚠️ **框架已实现**（待ROE数据获取） |
| **适用行业** | 银行/地产/周期股用PB，其他行业保持PE | ✅ **已实现**（可通过行业参数指定） |
| **双因子共振** | PE<20%分位 **AND** PB<20%分位 → 买入<br>PE>80%分位 **OR** PB>80%分位 → 卖出 | ✅ **已实现**（PE_PB_CombinedStrategy） |

**阈值校准**：
- 买入：PB<20%分位（与PE一致）✅
- 卖出：PB>80%分位（与PE一致）✅

**当前状态**：✅ **已实现**
- ✅ 创建了`fundamental_pb.py`（PB策略）
- ✅ 创建了`fundamental_pe_pb.py`（PE+PB双因子策略）
- ✅ 实现了分行业计算分位数（支持行业参数和行业PB数据）
- ✅ 实现了ROE过滤框架（待ROE数据获取后启用）
- ✅ 实现了双因子共振逻辑（"与/或"逻辑）
- ✅ 异常值过滤（PB<0或PB>20）

### 3. 市值（market_cap）过滤

| 实盘核心要点 | 权威标准 | 实现方式 |
|------------|---------|---------|
| **动态阈值适配** | 熊市/震荡市：过滤市值<50亿<br>牛市：可下调至30亿 | 股票池前置过滤 |
| **仓位与市值挂钩** | 50-100亿：仓位≤3%<br>100-500亿：仓位≤5%<br>>500亿：仓位≤8% | 策略层或回测层 |
| **排除次新股** | 上市未满1年的股票必须剔除 | 股票池过滤 |

**实现优先级**：✅ **高优先级**（最简单且效果明显）

### 4. 换手率（turnover_rate）辅助

| 实盘核心要点 | 权威标准 | 实现方式 |
|------------|---------|---------|
| **相对换手率** | 当前换手率 / 20日均换手率（非绝对数值） | 技术策略中补充 |
| **流动性过滤** | 相对换手率<0.5倍 → 回避<br>相对换手率>3倍 → 警惕利好兑现 | 信号过滤 |
| **信号增强** | 突破时要求相对换手率>1.2倍<br>回调时要求<0.8倍 | 信号验证 |

**为什么用相对换手率**：
- 小盘股日常换手率5%属于正常，大盘股5%就是异常放量
- 相对换手率更标准化，不受股票规模影响

**实现优先级**：✅ **高优先级**（直接增强现有技术策略）

**当前状态**：✅ **已实现**
- ✅ 创建了`turnover_helper.py`辅助模块
- ✅ 实现了相对换手率计算（当前换手率/20日均换手率）
- ✅ 实现了流动性过滤（相对换手率<0.5或>3.0时回避）
- ✅ 实现了信号增强（突破时要求>1.2倍，回调时要求<0.8倍）
- ✅ MA策略已集成换手率辅助
- ⏳ 其他技术策略（MACD、RSI、BOLL、KDJ）待集成

---

## 三、实盘扩展的权威优先级步骤

### 第一步：PE单因子策略实盘小资金试跑 ✅

**执行细节**：
1. 股票池限定：
   - 市值 > 50亿
   - PE TTM 0-100倍（剔除异常值）
   - 剔除ST/退市预警标的
   - 排除次新股（上市未满1年）

2. 分行业计算PE分位数：
   - 按申万一级行业分组
   - 每个行业独立计算3年滚动分位数

3. 仓位控制：
   - 单票仓位≤5%
   - 单一行业≤30%
   - 总仓位≤90%（预留现金）

4. 风控规则：
   - 单票止损：跌破买入价10%强制止损
   - 行业分散：单一行业仓位≤30%

**验证目标**：
- 跑通买入→持有→卖出全流程
- 确认年化收益、最大回撤、夏普比率是否符合回测预期
- 重点排查"滑点"和"冲击成本"（小盘股买卖时的隐性损耗）

**当前状态**：⚠️ **部分实现**（缺少行业分类、市值过滤、风控规则）

### 第二步：叠加PB因子，实现"双因子共振" ✅

**执行细节**：
1. 仅对银行/地产/周期股用PB替代PE，其他行业保持PE ✅ **已实现**（可通过行业参数指定）
2. 全行业执行：
   - 买入：PE<20%分位 **AND** PB<20%分位（低估时"与"逻辑，提高确定性）✅ **已实现**
   - 卖出：PE>80%分位 **OR** PB>80%分位（高估时"或"逻辑，快速止损）✅ **已实现**
3. 绑定ROE过滤：低PB必须搭配连续3年ROE>8% ⚠️ **框架已实现**（待ROE数据获取）

**验证目标**：
- 对比单PE策略，确认双因子策略的最大回撤是否降低
- 夏普比率是否提升
- 若未提升，说明PB在当前市场环境下无效，需暂停叠加

**当前状态**：✅ **已实现**
- ✅ PB策略已实现（`fundamental_pb.py`）
- ✅ PE+PB双因子策略已实现（`fundamental_pe_pb.py`）
- ⚠️ ROE数据获取待实现（ROE过滤框架已预留）

### 第三步：添加市值过滤 + 换手率辅助 ✅

**执行细节**：
1. 先上线市值过滤（前置风控）✅ **已实现**
2. 再在交易信号中加入相对换手率验证 ✅ **已实现**

**验证目标**：
- 观察策略的交易次数是否减少
- 冲击成本是否下降
- 换手率辅助的核心作用是"过滤假信号"，而非增加交易次数

**当前状态**：✅ **部分实现**
- ✅ 市值过滤：已在`batch_backtest.py`中实现
- ✅ 换手率辅助：已在MA策略中实现，其他策略待集成

---

## 四、实盘必须规避的3个权威坑点

### 1. ❌ 避免"全市场因子同质化"

**问题**：所有分位数计算必须分行业，这是量化实盘的底线

**示例**：
- 消费股PE 30倍是低估
- 周期股PE 30倍可能是高估

**解决方案**：
- 获取申万一级行业分类数据
- 按行业分组计算分位数
- 每个行业独立设置阈值（可选）

**当前状态**：⚠️ **未实现**（需要行业分类数据）

### 2. ❌ 避免"参数过拟合"

**问题**：历史分位数窗口不能为了优化回测收益而调整

**权威标准**：
- 窗口固定为3年（756天），覆盖1个完整牛熊周期
- 不要调整为1年或半年（过拟合的策略实盘必亏）

**当前状态**：⚠️ **可配置**（默认None=全部历史，建议改为756天）

### 3. ❌ 必须加入风控规则

**问题**：实盘交易不能只看估值，要搭配风控

**必须规则**：
1. **单票止损**：跌破买入价10%强制止损
2. **行业分散**：单一行业仓位≤30%
3. **仓位上限**：总仓位不超过90%，预留现金应对极端行情
4. **市值过滤**：市值<50亿（熊市/震荡市）或<30亿（牛市）
5. **异常值过滤**：PE<0或PE>100，ST/退市预警，次新股

**当前状态**：⚠️ **部分实现**（回测引擎有止损，但缺少行业分散、仓位上限）

---

## 五、实施计划

### 短期（1-2天）

1. ✅ **设置PE策略滚动窗口为3年（756天）**
   - 修改`PEStrategy._ROLLING_WINDOW = 756`
   - 更新文档说明

2. ✅ **添加PE异常值过滤**
   - 在`analyze`方法中过滤PE<0或PE>100

3. ✅ **实现市值过滤（股票池层面）**
   - 在`batch_backtest.py`中添加市值过滤选项
   - 默认过滤市值<50亿

4. ✅ **实现相对换手率辅助（技术策略）**
   - 创建了`turnover_helper.py`辅助模块
   - 实现了相对换手率计算（当前换手率/20日均换手率）
   - 实现了流动性过滤和信号增强
   - MA策略已集成换手率辅助
   - 其他技术策略（MACD、RSI、BOLL、KDJ）待集成

### 中期（1周）

5. ✅ **获取行业分类数据**
   - 使用tushare/akshare获取申万一级行业分类
   - 实现行业分类缓存

6. ✅ **实现分行业PE分位数计算**
   - 修改`PEStrategy`支持行业参数
   - 支持传入行业PE数据计算行业分位数
   - 基础框架已完成，待完善行业PE数据获取

7. ✅ **实现PB策略**
   - 复用PE策略代码
   - 添加ROE过滤逻辑（框架已实现，待ROE数据获取）

8. ✅ **实现PE+PB双因子策略**
   - 创建`PE_PB_CombinedStrategy`
   - 实现"与/或"逻辑（低估时"与"，高估时"或"）

### 长期（可选）

9. ⏳ **实现仓位与市值挂钩**
   - 修改回测引擎支持动态仓位上限
   - 根据市值设置单票仓位上限

10. ⏳ **实现行业分散风控**
    - 在回测引擎中跟踪行业仓位
    - 限制单一行业≤30%

---

## 六、数据需求清单

### 已获取 ✅
- PE TTM（日频）
- PB（日频）
- PS（日频）
- market_cap（日频）
- turnover_rate（日频）

### 待获取 ⏳
- **行业分类**（申万一级行业）
- **ROE**（季频，用于PB策略过滤）
- **ST/退市预警**（用于股票池过滤）
- **上市日期**（用于次新股过滤）

---

## 七、总结

**当前设计的合理性**：✅ **完全符合实盘铁律**

**需要改进的关键点**：
1. ✅ **分行业计算分位数**（实盘底线）- **已实现基础框架**
2. ✅ **滚动窗口固定3年**（避免过拟合）- **已实现**
3. ✅ **市值过滤**（前置风控）- **已实现**
4. ✅ **换手率辅助**（信号验证）- **已实现（MA策略）**
5. ⚠️ **风控规则**（行业分散、仓位上限）- **待实现**

**实施优先级**：
1. ✅ 市值过滤（最简单）- **已完成**
2. ✅ 换手率辅助（直接增强）- **已完成（MA策略）**
3. ✅ 滚动窗口固定（避免过拟合）- **已完成**
4. ✅ 分行业计算（实盘底线）- **已完成基础框架**
5. ✅ PB策略（双因子共振）- **已完成**
